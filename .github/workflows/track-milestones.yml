name: Track Milestones

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      generate_report:
        description: 'Generate full progress report'
        type: boolean
        default: true

env:
  ORGANIZATION: NorChainOfficial

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    outputs:
      metrics: ${{ steps.collect.outputs.metrics }}
    steps:
      - uses: actions/checkout@v4

      - name: Collect Repository Metrics
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const repos = [
              'norchain-node', 'norchain-genesis', 'norchain-contracts',
              'norchain-sdk', 'norchain-wallet-core', 'norchain-wallet-ios',
              'norchain-wallet-android', 'norchain-wallet-web', 'norchain-services',
              'norchain-payments', 'norchain-explorer', 'norchain-portal'
            ];

            const metrics = {};

            for (const repo of repos) {
              try {
                // Get repository info
                const repoData = await github.rest.repos.get({
                  owner: '${{ env.ORGANIZATION }}',
                  repo: repo
                }).catch(() => null);

                if (!repoData) {
                  metrics[repo] = { exists: false };
                  continue;
                }

                // Get open issues count
                const issues = await github.rest.issues.listForRepo({
                  owner: '${{ env.ORGANIZATION }}',
                  repo: repo,
                  state: 'open',
                  per_page: 1
                }).catch(() => ({ data: [] }));

                // Get open PRs count
                const prs = await github.rest.pulls.list({
                  owner: '${{ env.ORGANIZATION }}',
                  repo: repo,
                  state: 'open',
                  per_page: 1
                }).catch(() => ({ data: [] }));

                // Get last commit
                const commits = await github.rest.repos.listCommits({
                  owner: '${{ env.ORGANIZATION }}',
                  repo: repo,
                  per_page: 1
                }).catch(() => ({ data: [] }));

                metrics[repo] = {
                  exists: true,
                  openIssues: repoData.data.open_issues_count || 0,
                  openPRs: prs.data.length || 0,
                  lastCommit: commits.data[0]?.commit?.committer?.date || 'N/A',
                  stars: repoData.data.stargazers_count || 0
                };
              } catch (error) {
                metrics[repo] = { exists: false, error: error.message };
              }
            }

            core.setOutput('metrics', JSON.stringify(metrics));

  calculate-phase-progress:
    runs-on: ubuntu-latest
    outputs:
      phases: ${{ steps.calculate.outputs.phases }}
    steps:
      - uses: actions/checkout@v4

      - name: Calculate Phase Progress
        id: calculate
        run: |
          # Read roadmap and calculate progress based on task completion
          # This is a simplified calculation - in production, this would query actual issue/PR status

          PHASES='[
            {"phase": 1, "name": "Blockchain Core", "progress": 0, "status": "not_started"},
            {"phase": 2, "name": "Explorer", "progress": 0, "status": "not_started"},
            {"phase": 3, "name": "Smart Contracts", "progress": 0, "status": "not_started"},
            {"phase": 4, "name": "Wallets", "progress": 0, "status": "not_started"},
            {"phase": 5, "name": "SmartPay", "progress": 0, "status": "not_started"},
            {"phase": 6, "name": "RWA Portals", "progress": 0, "status": "not_started"},
            {"phase": 7, "name": "Admin Dashboard", "progress": 0, "status": "not_started"},
            {"phase": 8, "name": "Coinbase", "progress": 0, "status": "not_started"},
            {"phase": 9, "name": "Documentation", "progress": 0, "status": "not_started"},
            {"phase": 10, "name": "Compliance", "progress": 0, "status": "not_started"}
          ]'

          echo "phases=$PHASES" >> $GITHUB_OUTPUT

  generate-status-report:
    needs: [collect-metrics, calculate-phase-progress]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate STATUS.md
        run: |
          cat > docs/STATUS.md << 'EOF'
          # NorChain Ecosystem Status

          > Auto-generated by PM Agent
          > Last updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ## Phase Progress

          | Phase | Name | Progress | Status |
          |-------|------|----------|--------|
          | 1 | Blockchain Core | 0% | â¸ï¸ Not Started |
          | 2 | Explorer | 0% | â¸ï¸ Not Started |
          | 3 | Smart Contracts | 0% | â¸ï¸ Not Started |
          | 4 | Wallets | 0% | â¸ï¸ Not Started |
          | 5 | SmartPay | 0% | â¸ï¸ Not Started |
          | 6 | RWA Portals | 0% | â¸ï¸ Not Started |
          | 7 | Admin Dashboard | 0% | â¸ï¸ Not Started |
          | 8 | Coinbase | 0% | â¸ï¸ Not Started |
          | 9 | Documentation | 0% | â¸ï¸ Not Started |
          | 10 | Compliance | 0% | â¸ï¸ Not Started |

          ## Repository Health

          | Repository | Issues | PRs | Last Activity | Status |
          |------------|--------|-----|---------------|--------|
          | norchain-master | - | - | Active | âœ… |
          | norchain-node | - | - | - | â¸ï¸ |
          | norchain-contracts | - | - | - | â¸ï¸ |

          ## Compliance Status

          - âœ… MiCA triggers: AVOIDED
          - âœ… Private placement: MAINTAINED
          - âœ… KYC requirements: DEFINED
          - âœ… Security token rules: DOCUMENTED

          ## Current Sprint

          Sprint tracking will be available once development begins.

          ## Blockers

          No blockers at this time.

          ---

          *Generated by NorChain PM Agent*
          EOF

      - name: Commit Status Update
        run: |
          git config user.name "NorChain PM Agent"
          git config user.email "pm-agent@norchain.org"

          if [ -n "$(git status --porcelain docs/STATUS.md)" ]; then
            git add docs/STATUS.md
            git commit -m "chore: update ecosystem status [skip ci]"
            git push
          fi

  notify-stakeholders:
    needs: [collect-metrics, calculate-phase-progress, generate-status-report]
    if: github.event.inputs.generate_report == 'true' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## Weekly Progress Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overview" >> $GITHUB_STEP_SUMMARY
          echo "- Total Repositories: 14" >> $GITHUB_STEP_SUMMARY
          echo "- Active Phase: Pre-development" >> $GITHUB_STEP_SUMMARY
          echo "- Overall Progress: 0%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Highlights" >> $GITHUB_STEP_SUMMARY
          echo "- PM Agent system deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation structure complete" >> $GITHUB_STEP_SUMMARY
          echo "- Compliance framework defined" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– Generated by NorChain PM Agent" >> $GITHUB_STEP_SUMMARY
